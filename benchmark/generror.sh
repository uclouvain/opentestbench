#    Opentestbench : an open-source framework to assess the performances of image compression schemes
#    Copyright (C) 2015  intoPIX s.a. , Sébastien Lugan 
#    Copyright (C) 2015  Universite Catholique de Louvain, Alexandre Willème
#
#    Opentestbench is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#    
#   For any question please contact : 
#   Alexandre Willème (alexandre.willeme@uclouvain.be)


#!/bin/bash
export LANG=C

source benchmark/paths.sh

randomPositionFull=(0.840188 0.394383 0.783099 0.798440 0.911647 0.197551 0.335223 0.768230 0.277775 0.553970 0.477397 0.628871 0.364784 0.513401 0.952230 0.916195 0.635712 0.717297 0.141603 0.606969 0.016301 0.242887 0.137232 0.804177 0.156679 0.400944 0.129790 0.108809 0.998924 0.218257 0.512932 0.839112 0.612640 0.296032 0.637552 0.524287 0.493583 0.972775 0.292517 0.771358 0.526745 0.769914 0.400229 0.891529 0.283315 0.352458 0.807725 0.919026 0.069755 0.949327 0.525995 0.086056 0.192214 0.663227 0.890233 0.348893 0.064171 0.020023 0.457702 0.063096 0.238280 0.970634 0.902208 0.850920 0.266666 0.539760 0.375207 0.760249 0.512535 0.667724 0.531606 0.039280 0.437638 0.931835 0.930810 0.720952 0.284293 0.738534 0.639979 0.354049 0.687861 0.165974 0.440105 0.880075 0.829201 0.330337 0.228968 0.893372 0.350360 0.686670 0.956468 0.588640 0.657304 0.858676 0.439560 0.923970 0.398437 0.814767 0.684219 0.910972 0.482491 0.215825 0.950252 0.920128 0.147660 0.881062 0.641081 0.431953 0.619596 0.281059 0.786002 0.307458 0.447034 0.226107 0.187533 0.276235 0.556444 0.416501 0.169607 0.906804 0.103171 0.126075 0.495444 0.760475 0.984752 0.935004 0.684445 0.383188 0.749771 0.368664 0.294160 0.232262 0.584489 0.244413 0.152390 0.732149 0.125475 0.793470 0.164102 0.745071 0.074530 0.950104 0.052529 0.521563 0.176211 0.240062 0.797798 0.732654 0.656564 0.967405 0.639458 0.759735 0.093480 0.134902 0.520210 0.078232 0.069906 0.204655 0.461420 0.819677 0.573319 0.755581 0.051939 0.157807 0.999994 0.204329 0.889956 0.125468 0.997799 0.054058 0.870540 0.072329 0.004162 0.923069 0.593892 0.180372 0.163132 0.391690 0.913027 0.819695 0.359095 0.552485 0.579430 0.452576 0.687387 0.099640 0.530808 0.757294 0.304295 0.992228 0.576971 0.877614 0.747809 0.628910 0.035421 0.747803 0.833239 0.925377 0.873271 0.831038 0.979434 0.743811 0.903366 0.983596 0.666880 0.497259 0.163968 0.830012 0.888949 0.076995 0.649707 0.248044 0.629480 0.229137 0.700620 0.316867 0.328777 0.231428 0.074161 0.633072 0.223656 0.651132 0.510686 0.971466 0.280042 0.546107 0.719269 0.113281 0.471483 0.592540 0.944318 0.450918 0.336351 0.847684 0.434513 0.003231 0.344943 0.598481 0.833243 0.233892 0.675476 0.482950 0.481936 0.304956 0.712087 0.182556 0.621823 0.040864 0.413984 0.695984 0.673936 0.637640 0.347116 0.184622 0.609106 0.627158 0.730729 0.328374 0.740438 0.202213 0.920914 0.684757 0.653130 0.257265 0.532441 0.087644 0.260497 0.877384 0.686125 0.093740 0.111276 0.361601 0.576690 0.593211 0.666557 0.288778 0.775767 0.288379 0.329642 0.189751 0.984363 0.003579 0.827391 0.331479 0.188201 0.436497 0.958637 0.918930 0.764871 0.699075 0.121143 0.685786 0.383832 0.774274 0.943051 0.916273 0.861917 0.203548 0.793657 0.548042 0.297288 0.904932 0.909643 0.873979 0.498144 0.576200 0.162757 0.273911 0.864579 0.492399 0.463662 0.848942 0.495977 0.291053 0.180421 0.684178 0.727550 0.139058 0.603109 0.492422 0.838134 0.724252 0.178208 0.221966 0.498525 0.121259 0.138238 0.360443 0.324807 0.931895 0.908485 0.622095 0.836828 0.818128 0.496074 0.334972 0.394327 0.658831 0.608883 0.258906 0.151230 0.072545 0.107848 0.647207 0.363598 0.288270 0.331386 0.091149 0.427328 0.934495 0.583570 0.265461 0.658747 0.761778 0.487427 0.157272 0.883037 0.625665 0.517715 0.207844 0.557561 0.426199 0.829939 0.394388 0.244327 0.326013 0.729360 0.638654 0.984845 0.338243 0.897560 0.136075 0.410788 0.005409 0.783282 0.774386 0.293678 0.114668 0.865535 0.721006 0.049162 0.449105 0.986467 0.707909 0.210883 0.473894 0.865181 0.093920 0.099559 0.382896 0.301763 0.657120 0.809095 0.131702 0.051508 0.053422 0.457716 0.780868 0.692076 0.442560 0.119111 0.589637 0.578635 0.529899 0.595045 0.361917 0.304285 0.888723 0.476585 0.169820 0.609729 0.525747 0.618925 0.596196 0.233656 0.829808 0.070090 0.098837 0.923728 0.169649 0.481733 0.225491 0.826769 0.290829 0.357193 0.878278 0.344251 0.814909 0.659146 0.036327 0.257469 0.778257 0.625964 0.836104 0.308157 0.221009 0.198021 0.612442 0.109733 0.674605 0.782262 0.719462 0.200352 0.401188 0.315658 0.434009 0.230996 0.385748 0.532846 0.154724 0.555398 0.014579 0.380215 0.382167 0.305408 0.737408 0.260445 0.649659 0.552316 0.919591 0.685986 0.809785 0.697848 0.311950 0.645889 0.006005 0.532960 0.843910 0.618447 0.642693 0.518515 0.400709 0.362154 0.718867 0.801897 0.677812 0.152876 0.032893 0.063561 0.685722 0.187616 0.618958 0.700301 0.567831 0.001125 0.005709 0.305239 0.261570 0.655368 0.857555 0.181161 0.341354 0.667341 0.879009 0.653305 0.313230 0.885014 0.186265 0.157139 0.503461 0.828957 0.675654 0.904170 0.191112 0.394521 0.706067 0.868924 0.547397 0.738959 0.932485 0.233119 0.926576 0.551443 0.933420 0.494407 0.552568 0.939129 0.799646 0.814139 0.594497 0.657201 0.995300 0.935852 0.324541 0.874309 0.589157 0.637771 0.759324 0.775421 0.794910 0.262785 0.604379 0.470564 0.166955 0.795490 0.865085 0.873021 0.664414 0.412483 0.611981 0.596899 0.645602 0.538557 0.148342 0.579022 0.032963 0.700910 0.518151 0.832609 0.515049 0.112648 0.489810 0.510349 0.048500 0.814351 0.384658 0.637656 0.452122 0.143982 0.413078 0.247033 0.406767 0.017457 0.717597 0.573721 0.812947 0.582682 0.446743 0.477361 0.995165 0.058723 0.074260 0.640766 0.597280 0.222602 0.219788 0.630243 0.923513 0.737939 0.462852 0.438562 0.850586 0.952662 0.948911 0.899086 0.767014 0.333569 0.536743 0.219136 0.477551 0.949820 0.466169 0.884318 0.967277 0.183765 0.458039 0.780224 0.766448 0.904782 0.257585 0.761612 0.963505 0.331846 0.402379 0.560785 0.554448 0.622167 0.191028 0.477961 0.360105 0.653880 0.916523 0.210692 0.606542 0.865434 0.109778 0.373556 0.199003 0.646520 0.592692 0.676554 0.596341 0.058860 0.560872 0.563617 0.242626 0.018911 0.343841 0.009073 0.923692 0.601427 0.770686 0.887197 0.933273 0.173065 0.447982 0.487721 0.795231 0.639009 0.965682 0.155336 0.292889 0.882204 0.366028 0.899431 0.747638 0.475806 0.272987 0.946640 0.122326 0.865679 0.623194 0.718666 0.924540 0.184066 0.282284 0.167165 0.202977 0.626125 0.176239 0.126669 0.227552 0.946925 0.013866 0.160824 0.119989 0.461848 0.648545 0.915221 0.100857 0.614227 0.070557 0.393746 0.496431 0.436585 0.293177 0.244069 0.912391 0.566164 0.190709 0.034716 0.431844 0.813904 0.753383 0.356383 0.997970 0.035666 0.523548 0.200947 0.661792 0.699787 0.327616 0.889343 0.646712 0.341482 0.050168 0.766701 0.803330 0.698713 0.681922 0.904187 0.312940 0.752479 0.297933 0.809371 0.189064 0.591111 0.053439 0.101454 0.157275 0.244149 0.136171 0.589119 0.058052 0.889553 0.945502 0.056022 0.925220 0.469050 0.256969 0.587011 0.168837 0.584585 0.476355 0.815549 0.926068 0.526523 0.582250 0.729398 0.225236 0.264172 0.633585 0.538175 0.016651 0.931518 0.347546 0.205714 0.522629 0.400985 0.307168 0.679904 0.645134 0.443339 0.269022 0.703186 0.332892 0.214524 0.759208 0.258112 0.683574 0.016177 0.845123 0.852411 0.600763 0.321478 0.667960 0.526830 0.848000 0.250210 0.256228 0.073236 0.514382 0.889813 0.611411 0.531033 0.821331 0.958957 0.736747 0.343959 0.359942 0.043915 0.023863 0.005076 0.487254 0.292886 0.708262 0.820146 0.507410 0.467471 0.078258 0.190984 0.483648 0.923381 0.043395 0.084411 0.244858 0.711355 0.611241 0.092858 0.961565 0.867469 0.166094 0.475947 0.757282 0.777505 0.006980 0.578613 0.736462 0.743727 0.922572 0.096404 0.787642 0.946435 0.101480 0.274897 0.239321 0.809743 0.095043 0.746730 0.277214 0.173301 0.937714 0.760862 0.096681 0.981109 0.845273 0.341540 0.692463 0.456514 0.434398 0.654029 0.323983 0.600492 0.129976 0.081265 0.377997 0.136956 0.659878 0.114459 0.880683 0.582450 0.210863 0.668326 0.528885 0.312343 0.943222 0.768206 0.122086 0.038265 0.514936 0.399300 0.211565 0.452650 0.160162 0.308247 0.433758 0.005435 0.649787 0.126222 0.461949 0.084185 0.780250 0.785932 0.684677 0.910227 0.867197 0.062674 0.047183 0.527075 0.177133 0.927866 0.109525 0.387996 0.596191 0.638409 0.700340 0.539413 0.406615 0.822426 0.577678 0.921551 0.221726 0.789244 0.374201 0.381888 0.097491 0.807959 0.387323 0.747277 0.934181 0.849272 0.831462 0.714432 0.635204 0.516139 0.624658 0.502401 0.578813 0.671841 0.029476 0.755946 0.599707 0.139001 0.143942 0.195898 0.777410 0.844281 0.735311 0.184025 0.666707 0.312990 0.105576 0.888433 0.102233 0.479777 0.270321 0.199724 0.287736 0.657643 0.947001 0.221918 0.506915 0.778463 0.936349 0.142119 0.294601 0.561007 0.644520 0.873414 0.232848 0.673996 0.629359 0.832555 0.812997 0.773301 0.028453 0.590407 0.617582 0.763764 0.774432 0.284289 0.076753 0.880009 0.172722 0.178987 0.359786 0.443043 0.378710 0.647522 0.100686 0.325711 0.869440 0.607600 0.104174 0.805789 0.749719 0.398775 0.366796 0.394239 0.272189 0.599644 0.068235 0.901549 0.432199 0.881232 0.674850 0.460652 0.471639 0.292432 0.224415 0.246071 0.576721 0.301169 0.126080 0.749443 0.480155 0.485866 0.192486 0.858866 0.133388 0.293171 0.184577 0.002828 0.900772 0.288752 0.808617 0.650491 0.687527 0.175413 0.044729 0.959716 0.775058 0.112964 0.861265 0.207257 0.994196 0.536115 0.667908 0.465835 0.828546 0.892324 0.711906 0.405267 0.193493 0.837986 0.154711 0.673648 0.323852 0.347196 0.532514)


function generror
{
	test_name=$1
	codec=$2
	bpp=$3
	src_dir=$4
	src_dir_sb_factor=$5
	compa_dir=$6
	color_space=$7
	chroma_sub=$8
	bit_depth=$9
	image_size=${10}
	output_dir=${11}
	nerrors=${12}
  shift 12

  mkdir -p ${output_dir}/${test_name}
	test_dir=${output_dir}/${test_name}

	if [[ ("${color_space}" == "RGB") && ("${chroma_sub}" == "444") && (("${bit_depth}" == "8") || ("${bit_depth}" == "10") || ("${bit_depth}" == "12")) ]]; then
		extension=ppm
	elif [[ ("${color_space}" == "YCbCr") && ("${chroma_sub}" == "422") && ("${bit_depth}" == "10") ]]; then
		extension=yuv
		suffixdifftest=@${image_size}x3:[6-],[10-=0]:[6-]/2x1,[10-=1]/2x1:[6-]/2x1,[10-=2]/2x1
	elif [[ ("${color_space}" == "YCbCr") && ("${chroma_sub}" == "422") && ("${bit_depth}" == "12") ]]; then
		extension=yuv
		suffixdifftest=@${image_size}x3:[4-],[12-=0]:[4-]/2x1,[12-=1]/2x1:[4-]/2x1,[12-=2]/2x1
	fi

	countFail=0
	countSc=0
	echo -n "" >  ${output_dir}/psnr_${test_name}.dat
  for ((v=0; v<nerrors; ++v)); do
			errorPos=${randomPositionFull[$v]}
			errorPosName=${errorPos/./_}
			numBits=1
			bash benchmark/${codec}/${codec}.sh ${bpp} ${src_dir} ${src_dir_sb_factor} ${color_space} ${chroma_sub} ${bit_depth} ${image_size} ${test_dir} ${errorPos} ${numBits}
			i=0
			for f in $(find -L ${src_dir} -type f|grep -v ".txt$"|sort); do
				if [ ${i} = 0 ]; then
					g=${f##*/}
		  		name=${g/.*}
					#test_file=${test_dir}/${name}_${errorPos}.${extension}
					test_file=$(find -L ${test_dir} -type f -name ${name}_${codec}_${bpp}bpp_${errorPosName}_sc*.${extension})
					test_file_final_name=${test_dir}/${name}_${codec}_${bpp}bpp_${errorPosName}.${extension}
		  		compa_file=${compa_dir}/${name}.${extension}
#		      if [ ! -f ${test_file} ]; then
#		          echo ${name}_${errorPos} NaN >> ${output_dir}/psnr_${test_name}.dat
#		          let "countFail++"
#		      else
#		          result=$(${DIFFTESTPATH}/difftest_ng --asprec ${bit_depth} --psnr ${test_file}${suffixdifftest}  ${compa_file}${suffixdifftest} )
#		          result2=${result##*:}
#		          echo ${name}_${errorPos} ${result2} >> ${output_dir}/psnr_${test_name}.dat
#		      fi
					if [ -f ${test_file_final_name} ]; then
						result=$(${DIFFTESTPATH}/difftest_ng --asprec ${bit_depth} --psnr ${test_file_final_name}${suffixdifftest} ${compa_file}${suffixdifftest})
		    		psnr=${result##*:}
		    		echo ${name}_${errorPosName}.${extension} ${psnr} >> ${output_dir}/psnr_${test_name}.dat
					elif [ ${test_file} != "" ]; then
						temp=${test_file/.*}
						temp2=${temp##*_sc}
						realSize=${temp2/x*}
						targetSize=${temp2#*x}
						sizeExceeded=$(bc <<< "${realSize} > ${targetSize}")
						result=$(${DIFFTESTPATH}/difftest_ng --asprec ${bit_depth} --psnr ${test_file}${suffixdifftest} ${compa_file}${suffixdifftest})
						psnr=${result##*:}
						if [ ${sizeExceeded} = 1 ]; then
		    			echo ${name}_${errorPosName}.${extension} ${psnr} ${realSize} ${targetSize} !!! >> ${output_dir}/psnr_${test_name}.dat
							countSc=$(bc <<< "${countSc}+1")
						else
							echo ${name}_${errorPosName}.${extension} ${psnr} ${realSize} ${targetSize} >> ${output_dir}/psnr_${test_name}.dat
						fi
						mv ${test_file} ${test_file_final_name}
						else #if the file is not there
							echo ${name}_${errorPosName}.${extension} NaN >> ${output_dir}/psnr_${test_name}.dat
							let "countFail++"
		  			fi			
		  #    to remove the picture in the output folder
		  #    rm ${test_file}
				fi
				i=$(bc <<< "(${i}+1)%${src_dir_sb_factor}")
      done
	done
	echo NumberSizeExceeded ${countSc} >> ${output_dir}/psnr_${test_name}.dat
	echo numFail ${countFail} >> ${output_dir}/psnr_${test_name}.dat
}


# usage:
#   generror.sh test_name codec bpp src_dir src_dir_sb_factor compa_dir color_space chroma_sub bit_depth image_size output_dir nerrors

test_name=$1
codec=$2
bpp=$3
src_dir=$4
src_dir_sb_factor=$5
compa_dir=$6
color_space=$7
chroma_sub=$8
bit_depth=$9
image_size=${10}
output_dir=${11}
nerrors=${12}
shift 12

  
if [ -z ${test_name} ] || [ -z ${codec} ] || [ -z ${bpp} ] || [ -z ${src_dir} ] || [ -z ${src_dir_sb_factor} ] || [ -z ${compa_dir} ] || [ -z ${color_space} ] || [ -z ${chroma_sub} ] || [ -z ${bit_depth} ] || [ -z ${image_size} ] || [ -z ${output_dir} ] || [ -z ${nerrors} ]; then
  echo "Usage: generror.sh test_name codec bpp src_dir src_dir_sb_factor compa_dir color_space chroma_sub bit_depth image_size output_dir nerrors"
  exit 1
fi

generror ${test_name} ${codec} ${bpp} ${src_dir} ${src_dir_sb_factor} ${compa_dir} ${color_space} ${chroma_sub} ${bit_depth} ${image_size} ${output_dir} ${nerrors}
